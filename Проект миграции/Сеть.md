Настройка сети в облаке
=======================

Установка сети
--------------

### Базовый сервер

Основная настройка
    
    curl https://raw.githubusercontent.com/aiskov/vm-config/master/loader.py | python
    echo '{"name":"gateway","location":"Europe/Tallinn","locale":"en_US.UTF-8","provision-scripts":["python scripts/common.py"]}' > config.json
    python provision.py

Установка VPN

    apt-get install -y openvpn easy-rsa

Добавление ключей доступа

    make-cadir /etc/openvpn/easy-rsa
    cd /etc/openvpn/easy-rsa
    
Для изменения значений по умолчанию надо изменить файл `vars`, после чего можно сгенерировать ключи:
    
    source vars
    ./clean-all
    ./build-ca

Создать ключи доступа для сервера

    ./build-key-server server

Создать ключит доступа для каждого клиента

    ./build-key client1

И копируем их на сервер клиента в папку `/etc/openvpn`

Сгенерировать параметр Diffie-Hellman

    ./build-dh
    
Скопировать ключи в директорию настроек openvpn

    cd /etc/openvpn/easy-rsa/keys
    cp ca.crt dh2048.pem server.crt server.key /etc/openvpn

Установка фаервола 

    apt-get install -y firehol



Настройка сервера
-----------------

Настройка фаервола `/etc/firehol/firehol.conf`:

    version 5
    
    interface eth0 inet
      client all accept                           // allow all outgoing connections
      server ssh accept                           // allow all incoming SSH connections
      server openvpn accept src "1.2.3.4 2.3.4.5" // allow incoming OpenVPN connections
                                                  //   from these designated addresses 
                                                  //   NOTE: EDIT THESE ADDRESSES
    
    interface tun0 vpn                            
      server all accept                           // allow all incoming connections on the VPN 
      client all accept                           // allow all outgoing connections on the 
    
    router inet2vpn inface eth0 outface tun0
      route all accept                            // route freely to the VPN
    
    router vpn2inet inface tun0 outface eth0
      masquerade                                  // use NAT masquerading from the VPN
      route all accept                            // route freely to the VPN

Установка клиентов
------------------


Ссылки
------
* https://www.digitalocean.com/community/tutorials/7-security-measures-to-protect-your-servers
* https://www.digitalocean.com/community/tutorials/how-to-secure-traffic-between-vps-using-openvpn
